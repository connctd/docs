---
title: Connector Protocol
order: 3
---

The connector protocol consists of a set of callback URLs (called by the platform) and an API provided by the connctd platform, that defines a set of endpoints that can be called by the connector.
The callbacks are called by the connctd platform whenever a connector is installed or instantiated or when an action is performed on a thing.
The endpoints can be called by the connector to manage installations, instances and things and to update properties of specific things.

## Callbacks

In the following, we give detailed descriptions of the callbacks used in the connector protocol.
Note that all callbacks are required.
However, if your connector does not need a callback you could implement a version that does nothing expect from returning the expected results.

### Installation callback

Whenever a connector is installed on the connctd platform a POST request is send against the *installationCallbackURL* specified in the connector publication.
When a installation is removed a DELETE request is send against *installationCallbackURL/-installationId-*.

### New installation

```http
POST /-installationCallbackURL- HTTP/1.1
Content-Type: application/json
Signature: -base64encodedSignature-

{
   "id":"-installationID-",
   "token":"-installationToken-",
   "state":1,
   "configuration":[
      {
         "id":"-installationParameter-",
         "value":"-parameterValue-"
      }
   ]
}

Note: body was formatted for better readability
```

Note, that the request headers contain a signature.
Every request from the connctd platform will contain such a signature.
The signature must be verified by using the connector publication public key to verify the authenticity of the request.
Requests without a valid signature must be ignored, since it can not be guaranteed that those requests originate from the connctd platform.
The connector publication public key is shown once during connector publication, encoded as Base64.
In order to use it to verify a signature it must be decoded first.

Our [SDK connector-go](https://github.com/connctd/connector-go) provides a handler that verifies the signature of incoming requests.
If you would like to implement the verification on your own, the signature is created over the following canonicalized representation of the request:

`(method):-method-\r\n(url):-scheme-://-host--requestURI-\r\n(Date):-dateHeader-\r\n(body):-requestBody-`

You can also consult our [reference implementation](https://github.com/connctd/api-go/blob/main/crypto/signing.go) and [SDK](https://github.com/connctd/connector-go/blob/40807b6937086d5b1755368f0141e8ce27a22754/handlers.go#L24) for more details on how to implement the signature verification.

<!-- TODO: The private key (and in case of ed25519 thereby the public key) is stored in vault. We could restore the pub key, in case a connector developer looses it -->

#### Payload

`id` is the ID of the new installation generated by the connctd platform.
It is used for further communication with the platform and should be stored by the connector.

`token` is the ***installation token***, that is generated by the connctd platform for this specific installation that must be used for all request regarding this installation.
The connector should store it to be able to communicate with the connctd platform about this installation.

`state` is the current state of the installation.
It is initially set to **1** (**INITIALIZED**) and can have one of the values described [below](#installation-states).

`configuration` will contain all configuration parameters provided by the installation.
It will contain at least the required parameters and all parameters are type checked and validated according to the requirements specified in the connector publication before sending the request.
If an installation does not require any parameters, the array will be empty.
Parameters can be specified during connector publication.

#### Response

The connector has to respond with one of the following status codes: **201**, **202**, **401** or **403**.
Optionally the response can contain a payload specifying further steps required for the installation.
The content of field **furtherStep** will be shown in the [Developer Center](https://devcenter.connctd.io/), formatted according to its type.
The field **details** can contain an arbitrary JSON object.
If the connector responds with status code **202** and further steps, the installation state will be set to **ONGOING**.
In that case, it is the responsibility of the connector to update the installation state when the installation is finished.
To update the installation state the connector must send a request to the appropriate [API endpoint](#update-installation-state) described below.
<!-- TODO What is "details" used for? -->
<!-- TODO Add an example on how the payload / further step is used -->

```json
{
   "details": -arbitrary json object-,
   "furtherStep": {
      "type": -see installation step types-,
      "content": "Any content"
   }
}
```

The content type of **furtherStep** can have one of the values described [below](#installation-step-types).

If the connector responds with status code **201** the payload is ignored, because the status code indicates a successful installation.
If further steps are required, the connector should instead respond with status code **202**.

### Installation removal

```http
DELTETE /-installationCallbackURL-/-installationID- HTTP/1.1
Signature: -base64encodedSignature-
```

Whenever an installation is removed on the connctd platform, a DELETE request is send to the connector.
For more information on the signature read the documentation for [new installations](#new-installation).

#### Response

The connector should take appropriate actions on his side, e.g. remove the installation, and respond with status code **204** (**NO_CONTENT**).
If another status code is returned, an error message is returned to the app that is removing the installation, but the removal will still succeed.

#### Installation States

* 1: INITIALIZED

   Set by connctd when the installation of a connector was triggered.

* 2: COMPLETE

   Set by connctd as soon as the external connector service replied with 201 (Created) to the installation request.
   A connector is installed correctly only if it is in this state.

* 3: ONGOING

   Set by connctd as soon as the external connector service replied with 202 (Accepted) to the installation request.
   This indicates that external connector requires additional input.
   Instructions on further steps can be expressed by providing details and a further step field in the response to connctd.

* 4: FAILED

   Set by connctd as soon as the external connector service replied with 403 (Forbidden) or 401 (Unauthorized) to the installation request.
   This gives the external connector the possibility to signalize faulty configuration parameters (e.g. entered by developer).

* 5: ERROR

   Set by connctd as soon as the external connector service replied with an unexpected status code or when the response is malformed.
   In this case connctd responds with its own state details which should give external connector developers information on how to fix the problems.

* 6: INTERNAL_ERROR

   Set by connctd due to an internal issue.
   Leads to the cancellation of the installation.

* 7: REMOVAL_ONGOING

   Set by connctd as soon as an installation was marked for removal.

#### Installation step types

* 1: TEXT

   The corresponding value is interpreted as text.

* 2: MARKDOWN

   The corresponding value is interpreted as markdown.

* 3: REDIRECT

   The corresponding value is expected to be an URL.
   A link to the URL will be shown in the [Developer Center](https://devcenter.connctd.io/).

### Instance callback

While an App can only install a connector once, it can create multiple instantiations of the installed connector.
As soon as a connector is installed, instances of it can be spawned for different end users (separated by external subject ids).
Whenever a connector installation is instantiated on the connctd platform a POST request is send against the *instanceCallbackURL* specified in the connector publication.
When a instantiation is removed a DELETE request is send against *instanceCallbackURL/-installationId-*.

### New instantiation

```http
POST /-instanceCallbackUrl HTTP/1.1
Content-Type: application/json
Signature: -base64encodedSignature-

{
    "id": "-instanceId-",
    "installation_id": "-installationId",
    "token": "-instanceToken-",
    "state": 1,
    "configuration": [
        {
            "id": "-instantiationParameter-",
            "value": "-parameterValue-"
        }
    ]
}
```

See [installation documentation](#new-installation) for information on the signature.

#### Payload

`id` is the ID of the new instance generated by the conctd platform.
It is used for further communication with the platform and should be stored by the connector.

`token` is the ***instance token*** that is generated by the connctd platform for this specific instance.
It is used to authenticate requests towards the connctd platform and should be saved by the connector.

`state` is the current state of the instance.
It is set to **1** (**INITIALIZED**) and can have one of the values described [below](#instance-states).

`configuration` will contain all configuration parameters provided by the instantiation.
It will contain at least the required parameters and all parameters are type checked and validated according to the requirements specified in the connector publication before sending the request.
If an instantiation does not require any parameters, the array will be empty.
Parameters can be specified during connector publication.

#### Response

The connector has to respond with one of the following status codes: **201**, **202**, **401** or **403**.
Optionally the response can contain a payload specifying further steps required for the instantiation.
The field **details** can contain an arbitrary JSON object.
If the connector responds with status code **202** and further steps, the instantiation state will be set to **ONGOING**.
In that case, it is the responsibility of the connector to update the instantiation state when the instantiation is finished.
To update the instantiation state the connector must send a request to the appropriate [API endpoint](#update-instantiation-state) described below.
<!-- TODO What is "details" used for? -->
<!-- TODO Add an example on how the payload / further step is used -->

```json
{
   "details": -arbitrary JSON object-,
   "furtherStep": {
      "type": -see instantiation step types-,
      "content": "Any content"
   }
}
```

The content type of **furtherStep** can have one of the values described [below](#instantiation-step-types).

If the connector responds with status code **201** the payload is ignored, because the status code indicates a successful instantiation.
If further steps are required, the connector should instead respond with status code **202**.

### Instance removal

```http
DELTETE /-instanceCallbackURL-/-instanceID- HTTP/1.1
Signature: -base64encodedSignature-
```

Whenever an instance is removed on the connctd platform, a DELETE request is send to the connector.
For more information on the signature read the documentation for [new installations](#new-installation).

#### Response

The connector should take appropriate actions on his side, e.g. remove the instance, and respond with status code **204** (**NO_CONTENT**).
If another status code is returned, an error message is returned to the app that is removing the instance, but the removal will still succeed.

### Instantiation States

* 1: INITIALIZED

   Set by connctd when the instantiation of a connector was triggered.

* 2: COMPLETE

   Set by connctd as soon as the external connector service replied with 201 (Created) to the instantiation request.
   A connector is instantiated correctly only if it is in this state.

* 3: ONGOING

   Set by connctd as soon as the external connector service replied with 202 (Accepted) to the instantiation request.
   This indicates that external connector requires additional input.
   Instructions on further steps can be expressed by providing details and a further step field in the response to connctd.

* 4: FAILED

   Set by connctd as soon as the external connector service replied with 403 (Forbidden) or 401 (Unauthorized) to the instantiation request.
   This gives the external connector the possibility to signalize faulty configuration parameters (e.g. entered by developer).

* 5: ERROR

   Set by connctd as soon as the external connector service replied with an unexpected status code or when the response is malformed.
   In this case connctd responds with its own state details which should give external connector developers information on how to fix the problems.

* 6: INTERNAL_ERROR

   Set by connctd due to an internal issue.
   Leads to the cancellation of the instantiation.

* 7: REMOVAL_ONGOING

   Set by connctd as soon as an instantiation was marked for removal.

#### Instantiation step types

* 1: TEXT

   The corresponding value is interpreted as text.

* 2: MARKDOWN

   The corresponding value is interpreted as markdown.

* 3: REDIRECT

   The corresponding value is expected to be an URL.

### Action callback

Whenever an action is triggered on a thing, the connector is informed in order to implement the action.
The following request is sent against the ***actionCallbackUrl*** if an action is triggered.
For more information on how an action is triggered, see the [GraphQL API documentation](/graphql/things/#trigger-actions).

```http
POST -actionCallbackURL- HTTP/1.0
Content-Type: application/json
Signature: -base64encodedSignature- 

{
    "id": "-actionRequestId-",
    "thingId": "-thingId",
    "componentId": "-componentId-",
    "actionId": "-actionId-",
    "status": "-status-",
    "parameters": {
        "-key-": "-value-"
    }
}
```

#### Payload

`id` is the ID of the action request. It identifies this specific request, not the triggered action.

`thingId` is the ID of the thing the action is triggered on.

`componentId` is the ID of the component that contains the action. Remember, that an action is always part of an component.

`status` is the current status of the action request. It s initially set to **PENDING** by the connctd platform. See [below](#action-states) for all possible values.

`parameters` is a map of key-value pairs, containing the parameters for the action. Parameters are defined during thing creation.

#### Response

The connector should perform the action and respond with one of the following status codes: **200**, **204**, **400** of **403**.

If the connector responds with status code **200**, the response can optionally contain a payload specifying the status of the action and an optional error message.
This allows a connector to signal a pending action to the connctd platform.
It is the responsibility  of the connector to later on update the state of the action using the API described [below](#update-action-request-status).

If the connector replies with **204** (**No Content**) the response body is ignored and the action is interpreted as COMPLETED.

If the connector replies with **400** (**Bad Request**) the response body is ignored and the action is interpreted as FAILED with an appropriate error message (bad parameters).

If the connector replies with **403** (**Forbidden**) the response body is ignored and the action is interpreted as FAILED with an appropriate error message (action not allowed).

#### Action states

* PENDING

   Connector is still processing the action and later on sends an action request update about completion or failure.

* COMPLETED

   Action was performed successfully.

* FAILED

   Action was not performed due to an error. The connector is expected to send an error description in the response.
   Probable causes are insufficient privileges, bad parameters or that the underlying device is not reacting.

* CANCELED

   Action was cancelled.

## Connctd API

The connctd platform provides an API that can be used to manage the whole lifecycle of a connector by creating, updating and deleting installation, instances and things.
In the following we give a detailed description of the API used for connectors.

### Update Installation State

Connectors can update the state of installations using the installation token.
Installation state can only be updated to **COMPLETE**, **ONGOING** or **FAILED**.

```http
POST https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things
Authorization: Bearer -installation token-
Content-Type: application/json

{
	"state": -installation state: COMPLETE or ONGOING or FAILED-,
	"details": -arbitrary json object-
}
```

Connectors can attach an arbitrary JSON object to communicate details about the installation state.
<!-- TODO: How exactly is state details uses in the connectorhub? -->

#### Response

If no error occurs, the connctd platform will respond with status code **204** (**NO_CONTENT**).

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "Given installation state details are not valid",
}
```

### Update Instantiation State

Connectors can update the state of installations using the installation token.
Installation state can only be updated to **COMPLETE**, **ONGOING** or **FAILED**.

```http
POST https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things
Authorization: Bearer -instance token-
Content-Type: application/json

{
	"state": -instance state: COMPLETE or ONGOING or FAILED-,
	"details": -arbitrary json object-
}
```

Connectors can attach an arbitrary JSON object to communicate details about the instance state.
<!-- TODO: How exactly is state details uses in the connectorhub? -->

#### Response

If no error occurs, the connctd platform will respond with status code **204** (**NO_CONTENT**).

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

<!-- TODO: explain requestId -->
```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "Given installation state details are not valid",
}
```

### Create Thing

Connectors can register new things on the connctd platform.
Things are always bound to a connector instance and registration needs the **instance token** retrieved during creation of the instance (see [instance creation](#new-instantiation)).

```http
POST https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things
Authorization: Bearer -your instance token-
Content-Type: application/json

{  
  "thing": {
    "name":"-thing name",
    "manufacturer":"-manufacturer name-",
    "displayType":"",
    "mainComponentId":"",
    "status":"UNAVAILABLE",
    "components":[
       {
          "id":"",
          "name":"",
          "componentType":"",
          "capabilities":[
          ],
          "properties":[
             {
                "id":"value",
                "name":"value",
                "value":"",
                "unit":"",
                "type":"STRING",
                "lastUpdate":"",
                "propertyType":""
             }
          ],
          "actions":[
          ]
       }
    ]
    }
 }
 ```

The status of thing can have one of the following values:

* UNKNOWN: The current state of the thing is unknown
* AVAILABLE: The underlying device/service is reachable
* UNAVAILABLE: Underlying device/service not reachable

The type of a property can be **STRING**, **NUMBER** or **BOOLEAN**.

#### Response

If no error occurs, the connctd platform will respond with status code **201** (**CREATED**) and an JSON object containing the ID of the newly created thing.

```JSON
StatusCode: 201 Created

{
    "id": "bffbb9c6-2ad8-44f9-9668-7503a16954ec"
}
```

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

<!-- TODO: explain requestId -->
```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "The client body couldn't be decoded",
    "requestId": "-request id-"
}
```

### Update Thing Property

Using an instance token, a connector can update thing properties for the instance.

```http
POST https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things/-thingID-/components/-componentID-/properties/-propertyID-
Authorization: Bearer -your instance token-
Content-Type: application/json

{  
  "value":"-new value-",
  "lastUpdate": -RFC3339 formatted timestamp-
}
```

If no error occurs the connctd platform will respond with status code **204** (**NO_CONTENT**).
In case of an error an the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "The client body couldn't be decoded",
    "requestId": "-request id-"
}
```

### Update Thing Status

Using an instance token, a connector can update the status of a thing.
See [thing status](#create-thing) for all available states.

```http
PUT https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things/-thingID-/status
Authorization: Bearer -your instance token-
Content-Type: application/json

{  
	"status":"-new thing status-"
}
```
#### Response

If no error occurs, the connctd platform will respond with status code **204** (**NO_CONTENT**).

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

<!-- TODO: explain requestId -->
```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "The client body couldn't be decoded",
    "requestId": "-request id-"
}
```

### Remove Thing

Using an instance token, a connector can remove things.

```http
DELETE https://connectors.connctd.io/api/v1/connectorhub/callback/instances/things/-thingID-
Authorization: Bearer -your instance token-
```

#### Response

If no error occurs, the connctd platform will respond with status code **204** (**NO_CONTENT**).

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

<!-- TODO: explain requestId -->
```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "The client body couldn't be decoded",
    "requestId": "-request id-"
}
```

### Update Action Request Status

Some actions may need some time for completion.
In such a case a connector can reply to an incoming action request with status code **200** and the status **PENDING** (see [action callback](#action-callback)).
To finalize a **PENDING** action request, the connector must update the action request state as soon as the action is completed.
Connectors can use the following API endpoint to update the action request.
Note that only **PENDING** requests can be updated.

```http
PUT https://connectors.connctd.io/api/v1/connectorhub/callback/instances/actions/requests/-actionRequestID-
Authorization: Bearer -instanceToken-
Content-Type: application/json

{  
	"status":"COMPLETED or FAILED",
	"error":"-optional error message if status is FAILED"
}
```

The status can only be updated to **COMPLETED** or **FAILED** and only if the current status is **PENDING**.
Note that the status of an action request can change from **PENDING** to **COMPLETED** or **FAILED** without the knowledge of the connector, due to an cancellation request or timeout.
In that case, an error is returned to the connector.
If the status is updated to **COMPLETED**, no error message must be send.

#### Response

If no error occurs, the connctd platform will respond with status code **204** (**NO_CONTENT**).

In case of an error the connctd platform will respond with status code **40x** or **50x** and a JSON object with details on the error is returned.

<!-- TODO: explain requestId -->
```JSON
StatusCode: -depends on status in error-
{
    "error": "BAD_REQUEST",
    "status": 400,
    "description": "The client body couldn't be decoded",
    "requestId": "-request id-"
}
```
